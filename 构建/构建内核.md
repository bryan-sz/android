# ACK内核
- ACK（Android common kernel）是AOSP社区的内核主线，代码路径：https://android.googlesource.com/kernel/common/,是在Linux kernel社区基础上开发的Android内核版本;
- 关于ACK更多信息，请参考：https://source.android.com/docs/core/architecture/kernel?hl=zh-cn；
# ACK内核构建
- 下载好的ACK工程如下图所示，其中内核源码位于common目录；
![image](https://github.com/bryan-sz/android/assets/65610624/f939bc86-f20f-43a2-a2cd-bc32604631b1)
- 在https://source.android.com/docs/setup/build/building-kernels?hl=zh-cn这篇文章中介绍了编译Android版本中内核的方法,本文主要对这篇文章进行一个补充说明；
## 构建命令
- 以构建常用的arm64架构的内核为例，直接运行如下命令，就能得到编译的内核；
```
tools/bazel build //common:kernel_aarch64_dist
```
## bazel
- 从上面的命令可以看到，依赖了tools目录下的bazel，具体bazel的使用方法，可以参考：[Bazel](https://bazel.google.cn/versions/6.2.0/build/style-guide?hl=pl);
- 而bazel是二进制文件，和以往的build.sh脚本文件不同，无法直观的通过源码看到内核的构建过程，只能通过其他方式来查看构建过程；
- 我尝试编译了一把，不出意外的失败了，日志输出如下：
```
root@CHENGANG15-D1MA:/home/chengang15/android-kernel# tools/bazel build //common:kernel_aarch64_dist
Extracting Bazel installation...
Starting local Bazel server and connecting to it...
INFO: Analyzed target //common:kernel_aarch64_dist (59 packages loaded, 96995 targets configured).
INFO: Found 1 target...
ERROR: /home/chengang15/android-kernel/common/BUILD.bazel:100:22: Creating kernel config (lto=default;notrim) @//common:kernel_aarch64_config failed: (Exit 2): bash failed: error executing KernelConfig command (from target //common:kernel_aarch64_config) /bin/bash -c ... (remaining 1 argument skipped)

Use --sandbox_debug to see verbose messages from the sandbox and retain the sandbox build root for debugging
Internal error. Please report to android-llvm@google.com.
compiler_wrapper.go:275: failed to execute &main.command{Path:"/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/prebuilts/clang/host/linux-x86/clang-r498229b/bin/clang.real", Args:[]string{"-Wp,-MMD,scripts/basic/.fixdep.d", "-Wall", "-Wmissing-prototypes", "-Wstrict-prototypes", "-O2", "-fomit-frame-pointer", "-std=gnu11", "-iquote", "/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/.", "-iquote", "/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin", "-I/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/prebuilts/kernel-build-tools/_virtual_includes/linux_x86_imported_libs", "--sysroot=/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/build/kernel/build-tools/sysroot", "-I", "./scripts/basic", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibbase.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibc++.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibcrypto-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibcrypto.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibcrypto_Uutils.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibcutils.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibelf.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext2_Ublkid-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext2_Ucom_Uerr-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext2_Ue2p-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext2_Uquota-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext2_Uuuid-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext2fs-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibext4_Uutils.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibfdt.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibicui18n-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibicuuc-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibinterceptor.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Sliblog.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Sliblp.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibsparse-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibsqlite.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-L/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/bazel-out/k8-opt-exec-ST-cc34b0dd6772/bin/_solib_x86_64/_U_S_Sprebuilts_Skernel-build-tools_Clinux_Ux86_Uimported_Ulibs_Ulinux-x86_Slib64_Slibz-host.so___Uprebuilts_Skernel-build-tools_Slinux-x86_Slib64", "-fuse-ld=lld", "--rtlib=compiler-rt", "--sysroot=/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/build/kernel/build-tools/sysroot", "-o", "scripts/basic/fixdep", "/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/common/scripts/basic/fixdep.c"}, EnvUpdates:[]string(nil)}: go_exec.go:23: exec error: exec format error
make[3]: *** [/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/common/scripts/Makefile.host:114: scripts/basic/fixdep] Error 1
make[2]: *** [/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/common/Makefile:651: scripts_basic] Error 2
make[1]: *** [/home/chengang15/android-kernel/out/bazel/output_user_root/7c2c03c813bb0e583388ece90bc4609d/sandbox/processwrapper-sandbox/9/execroot/__main__/common/Makefile:252: __sub-make] Error 2
make: *** [Makefile:252: __sub-make] Error 2
Target //common:kernel_aarch64_dist failed to build
Use --verbose_failures to see the command lines of failed build steps.
ERROR: /home/chengang15/android-kernel/common/BUILD.bazel:100:22 Middleman _middlemen/common_Skernel_Uaarch64_Udist-runfiles failed: (Exit 2): bash failed: error executing KernelConfig command (from target //common:kernel_aarch64_config) /bin/bash -c ... (remaining 1 argument skipped)

Use --sandbox_debug to see verbose messages from the sandbox and retain the sandbox build root for debugging
INFO: Elapsed time: 146.704s, Critical Path: 102.52s
INFO: 407 processes: 399 internal, 8 processwrapper-sandbox.
ERROR: Build did NOT complete successfully
```
- 从日志来看，是在make config的阶段就出错了，而这个make config是在common/BUILD.bazel文件第100行；
- 而BUILD.bazel文件第100行长这样，这也看不出来是make config阶段的问题呀：
```
define_common_kernels(target_configs = {
    "kernel_aarch64": {
        "module_implicit_outs": get_gki_modules_list("arm64"),
        "make_goals": _GKI_AARCH64_MAKE_GOALS,
    },
    "kernel_riscv64": {
        "module_implicit_outs": get_gki_modules_list("riscv64"),
        "make_goals": _GKI_RISCV64_MAKE_GOALS,
    },
    "kernel_x86_64": {
        "kmi_symbol_list_strict_mode": False,
        "module_implicit_outs": get_gki_modules_list("x86_64"),
        "make_goals": _GKI_X86_64_MAKE_GOALS,
    },
})
```

